# Freedom Group Backend - Обработка Excel файлов

## Новая функциональность: Извлечение данных из листа Partner

### Описание

При загрузке Excel файлов через админ-панель, система автоматически:
1. Партнер выбирается в интерфейсе администратора
2. Извлекает данные из листа "Partner" (формат key-value)
3. Сохраняет эти данные в базу данных
4. Удаляет лист "Partner" из файла перед сохранением
5. Сохраняет модифицированный файл (без листа Partner)

### Формат листа Partner

Лист должен содержать два столбца:
- **Первый столбец (name)**: название поля
- **Второй столбец (value)**: значение поля

#### Обязательные поля:

| Название поля | Описание | Пример |
|---------------|----------|--------|
| period from | Начало периода | 1/1/2026 |
| period till | Конец периода | 1/31/2026 |
| net | Чистая сумма | 50000 |
| invoice | Сумма к оплате | 53190 |
| tax | Сумма налога | 3190 |

#### Опциональные поля:

| Название поля | Описание | Пример | По умолчанию |
|---------------|----------|--------|--------------|
| type | Тип документа | Счет | (пусто) |
| full name | Полное имя | Андрей Билевич | (пусто) |
| created | Дата создания | 1/30/2026 | Текущая дата |
| currency | Валюта | RUB | RUB |

### Пример структуры

```
| name        | value              |
|-------------|-------------------|
| type        | Счет              |
| full name   | Андрей Билевич    |
| created     | 1/30/2026         |
| period from | 1/1/2026          |
| period till | 1/31/2026         |
| net         | 50000             |
| invoice     | 53190             |
| tax         | 3190              |
| currency    | RUB               |
```

**Примечание:** Код партнера (inc) больше не требуется в Excel файле, так как партнер выбирается в интерфейсе администратора при загрузке файлов.

### Важные замечания

1. **Партнер выбирается в UI** - администратор выбирает партнера для файлов в интерфейсе
2. **Названия полей нечувствительны к регистру** - "Net", "net", "NET" будут одинаково обработаны
3. **Пробелы в названиях полей игнорируются** - "period from" и "periodfrom" одинаковы
4. **Даты в формате Excel** - числовые значения автоматически конвертируются в даты
5. **Удаление листа Partner** - происходит автоматически перед сохранением файла

### Миграция базы данных

Перед использованием новой функциональности необходимо выполнить миграцию:

```bash
npm run migrate
```

Это добавит новые поля в таблицу `claim`:
- `type` (TEXT)
- `fullName` (TEXT)
- `created` (DATETIME)
- `currency` (TEXT, по умолчанию 'RUB')

### API Response

После успешной загрузки, API вернет информацию о загруженных файлах:

```json
{
  "success": true,
  "message": "Обработано файлов: 1, ошибок: 0",
  "results": [
    {
      "fileName": "invoice_example.xlsx",
      "partnerId": 10,
      "partnerName": "Partner Name",
      "claimId": 123,
      "documentId": 456,
      "type": "Счет",
      "fullName": "Андрей Билевич",
      "period": "1/1/2026 - 1/31/2026",
      "amount": 50000,
      "currency": "RUB",
      "status": "uploaded"
    }
  ],
  "errors": []
}
```

### Обработка ошибок

Система проверяет:
- ✅ Наличие листа "Partner" в файле
- ✅ Наличие всех обязательных полей
- ✅ Корректность формата данных
- ✅ Существование партнера с указанным кодом

При ошибке, файл не будет обработан, и информация об ошибке будет включена в массив `errors` ответа API.

### Скачивание файлов партнерами

Когда партнер скачивает файл, он получает **модифицированную версию** без листа "Partner". Служебная информация остается только в базе данных.
