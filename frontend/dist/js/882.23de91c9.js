"use strict";(self["webpackChunkapp"]=self["webpackChunkapp"]||[]).push([[882],{601:function(e,a,t){t.r(a),t.d(a,{default:function(){return F}});var o=t(6768),l=t(4232),r=t(144),n=t(5130),s=t.p+"img/email.ace930b4.svg";const c={class:"send-again-btn"};function u(e,a){return(0,o.uX)(),(0,o.CE)("button",c," Отправить повторно ")}var i=t(1241);const d={},v=(0,i.A)(d,[["render",u],["__scopeId","data-v-e960c97a"]]);var g=v,p=t(2261),h=t(4373),f=t(1387);
/*! js-cookie v3.0.5 | MIT */
function m(e){for(var a=1;a<arguments.length;a++){var t=arguments[a];for(var o in t)e[o]=t[o]}return e}var y={read:function(e){return'"'===e[0]&&(e=e.slice(1,-1)),e.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function k(e,a){function t(t,o,l){if("undefined"!==typeof document){l=m({},a,l),"number"===typeof l.expires&&(l.expires=new Date(Date.now()+864e5*l.expires)),l.expires&&(l.expires=l.expires.toUTCString()),t=encodeURIComponent(t).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var r="";for(var n in l)l[n]&&(r+="; "+n,!0!==l[n]&&(r+="="+l[n].split(";")[0]));return document.cookie=t+"="+e.write(o,t)+r}}function o(a){if("undefined"!==typeof document&&(!arguments.length||a)){for(var t=document.cookie?document.cookie.split("; "):[],o={},l=0;l<t.length;l++){var r=t[l].split("="),n=r.slice(1).join("=");try{var s=decodeURIComponent(r[0]);if(o[s]=e.read(n,s),a===s)break}catch(c){}}return a?o[a]:o}}return Object.create({set:t,get:o,remove:function(e,a){t(e,"",m({},a,{expires:-1}))},withAttributes:function(e){return k(this.converter,m({},this.attributes,e))},withConverter:function(e){return k(m({},this.converter,e),this.attributes)}},{attributes:{value:Object.freeze(a)},converter:{value:Object.freeze(e)}})}k(y,{path:"/"});const w=(0,p.nY)("main",(()=>{const e=(0,r.KR)(!1),a=(0,r.KR)(""),t=(0,r.KR)(""),o=(0,r.KR)(!1),l=(0,r.KR)(!1),n=(0,f.rd)(),s=(0,r.KR)(""),c=(0,r.KR)(""),u=(0,r.KR)(null),i=(0,r.KR)(!1),d=(0,r.KR)({}),v=r.KR<File|!1,g=r.KR<File|!1,p=(0,r.KR)(!1),m=(0,r.KR)(""),y=(0,r.KR)(""),k=(0,r.KR)(!1),w=(0,r.KR)(!1),R=(0,r.KR)([]),j=(0,r.KR)({}),S=(0,r.KR)(""),b=(0,r.KR)([]),A=(0,r.KR)({}),K=(0,r.KR)([]),I=(0,r.KR)({}),C=(0,r.KR)([]),E=()=>d.value&&d.value.role&&"administrator"===d.value.role.type,F=async()=>{try{e.value=!0,p.value=!1,O();let t=await h.A.post("/email-auth/send-code",{email:a.value});console.log(t),t.data.success?(M("Код отправлен на вашу почту"),n.push({name:"email_verify"})):!1===t.data.userExists&&(p.value=!0,N("Пользователь с такой почтой не найден"))}catch(t){console.log(t),N("Ошибка при отправке кода. Попробуйте позже")}finally{e.value=!1}},x=async()=>{try{e.value=!0,O();let t=await h.A.post("/email-auth/send-code",{email:a.value});console.log(t),t.data.success&&M("Код отправлен повторно")}catch(t){console.log("Ошибка при повторной отправке кода:",t),N("Ошибка при повторной отправке кода")}finally{e.value=!1}},T=async()=>{try{e.value=!0,O();let o=await h.A.post("/email-auth/verify-code",{email:a.value,code:t.value});if(o.data.jwt){U(o.data.jwt,o.data.refreshToken),d.value=o.data.user,i.value=!0,localStorage.setItem("user",JSON.stringify(o.data.user)),M("Успешная авторизация!");const e=localStorage.getItem("returnUrl");e?(localStorage.removeItem("returnUrl"),n.push(e)):n.push({name:"proekts"})}else N("Неверный код подтверждения")}catch(o){console.log("Ошибка при проверке кода:",o),N("Неверный код подтверждения")}finally{e.value=!1}},U=(e,a)=>{s.value=e,c.value=a;const t=(new Date).getTime()+9e5;u.value=t,localStorage.setItem("jwt",e),localStorage.setItem("refreshToken",a),localStorage.setItem("tokenExpiration",t.toString()),h.A.defaults.headers.common["Authorization"]=`Bearer ${e}`},D=()=>!(!s.value||!u.value)&&(new Date).getTime()<u.value,$=async()=>{try{if(!c.value)throw new Error("No refresh token available");const e=await h.A.post("/auth/refresh",{refreshToken:c.value});return!!e.data.jwt&&(U(e.data.jwt,e.data.refreshToken||c.value),e.data.user&&(d.value=e.data.user,localStorage.setItem("user",JSON.stringify(e.data.user))),!0)}catch(e){return console.log("Ошибка обновления токена:",e),!1}},P=()=>{s.value="",c.value="",u.value=null,i.value=!1,d.value={},localStorage.removeItem("jwt"),localStorage.removeItem("refreshToken"),localStorage.removeItem("tokenExpiration"),localStorage.removeItem("user"),delete h.A.defaults.headers.common["Authorization"],n.push({name:"login"})},L=()=>{const e=localStorage.getItem("jwt"),a=localStorage.getItem("refreshToken"),t=localStorage.getItem("tokenExpiration"),o=localStorage.getItem("user");if(console.log("Initializing auth:",{savedJwt:!!e,savedRefreshToken:!!a,savedUser:o}),e&&a){if(s.value=e,c.value=a,t&&(u.value=parseInt(t)),o)try{const e=JSON.parse(o);d.value=e,console.log("User restored from localStorage:",e)}catch(l){console.error("Ошибка парсинга данных пользователя:",l)}h.A.defaults.headers.common["Authorization"]=`Bearer ${e}`,i.value=!0,console.log("User state restored from localStorage")}else console.log("No saved tokens found")},B=async()=>{if(!i.value)return!1;if(!D()){const e=await $();if(!e)return i.value=!1,!1}return!0},_=async()=>{const e=await B();return!!e||(N("Сессия истекла. Необходимо войти в систему заново."),n.push({name:"login"}),!1)},N=e=>{m.value=e,k.value=!0,setTimeout((()=>{k.value=!1,m.value=""}),5e3)},M=e=>{y.value=e,w.value=!0,setTimeout((()=>{w.value=!1,y.value=""}),3e3)},O=()=>{k.value=!1,w.value=!1,m.value="",y.value=""},z=async(a=null,t=null)=>{try{e.value=!0,O();const n=a||v.value;if(!n)return void N("Файл не выбран");const s=new FormData;s.append("excel",n),t&&t.trim()&&s.append("projectName",t.trim());let c=await h.A.post("/proekt/excel-upload",s,{headers:{"Content-Type":"multipart/form-data"}});if(c.data&&c.data.project){M("Проект успешно создан"),o.value=!1,S.value=c.data.project.id.toString(),console.log("Updated proektId to:",S.value);try{console.log("excelFile before clearing:",v),console.log("typeof excelFile:",typeof v),v&&"object"===typeof v&&"value"in v?v.value=null:console.warn("excelFile is not a proper ref object:",v)}catch(l){console.error("Error clearing excelFile:",l)}try{await q()}catch(r){console.log("Failed to refresh projects list:",r)}}else N("Ошибка при создании проекта: неожиданный ответ сервера")}catch(s){if(console.log("Error creating project:",s),403===s.response?.status)N("Недостаточно прав. Требуются права администратора."),n.push("/access-denied");else{const e=s.response?.data?.message||s.message||"Неизвестная ошибка";N("Ошибка при создании проекта: "+e)}}finally{e.value=!1}},V=(0,r.KR)(!1),J=(0,r.KR)("techcard"),X=async(a=null)=>{try{const o=await B();if(!o)return;e.value=!0,O(),console.log("tehkartaUpload: checking for file..."),console.log("tehkartaFile.value:",g.value),console.log("fileParam:",a);const r=a||g.value;if(!r)return console.log("No file available, showing error"),N("Файл не выбран"),void(e.value=!1);console.log("Creating FormData with file:",r);const n=new FormData;n.append("excel",r);let s=await h.A.post(`/element-tehkarties/createTechCardsFromExcel?proektId=${S.value}&isReplacing=${V.value}`,n);if(console.log(s),s.data){console.log("Upload successful, response data:",s.data);let e=`Техкарта загружена: создано ${s.data.techCardsCreated} элементов`;s.data.techCardsSkipped>0&&(e+=`, пропущено ${s.data.techCardsSkipped} записей без материала`),M(e),l.value=!1,console.log("tehkartaFile type before clearing:",typeof g),console.log("tehkartaFile value before clearing:",g),g&&"object"===typeof g&&"value"in g?g.value=null:console.error("tehkartaFile is not a ref object, skipping clear:",g);try{await q(),console.log("Projects reloaded successfully")}catch(t){console.error("Error reloading projects:",t)}}}catch(o){console.error("Error in tehkartaUpload:",o),403===o.response?.status?(N("Недостаточно прав. Требуются права администратора."),n.push("/access-denied")):(o.response&&console.error("Response error:",o.response.data),N("Ошибка при загрузке техкарты: "+(o.response?.data?.message||o.message)))}finally{e.value=!1}},Y=async(a=null)=>{try{const o=await B();if(!o)return;e.value=!0,O(),console.log("replaceProjectElements: checking for file..."),console.log("tehkartaFile.value:",g.value),console.log("fileParam:",a);const r=a||g.value;if(!r)return console.log("No file available, showing error"),N("Файл не выбран"),void(e.value=!1);console.log("Creating FormData with file:",r);const n=new FormData;n.append("excel",r);let s=await h.A.put(`/proekt/${S.value}/replace-tech-card`,n);if(console.log(s),s.data){console.log("Replace successful, showing success message"),M("Проект успешно заменен"),l.value=!1,console.log("tehkartaFile type before clearing:",typeof g),console.log("tehkartaFile value before clearing:",g),g&&"object"===typeof g&&"value"in g?g.value=null:console.error("tehkartaFile is not a ref object, skipping clear:",g);try{await q(),console.log("Projects reloaded successfully")}catch(t){console.error("Error reloading projects:",t)}}}catch(o){console.error("Error in replaceProjectElements:",o),o.response&&console.error("Response error:",o.response.data),N("Ошибка при замене проекта: "+(o.response?.data?.message||o.message))}finally{e.value=!1}},q=async()=>{try{let e=await h.A.get("/proekts");R.value=e.data.projects}catch(e){throw console.log("Error loading projects:",e.message),e}},Q=async e=>{try{let a=await h.A.get(`/proekts/${e}`);j.value=a.data.project}catch(a){console.log(a)}},W=async()=>{try{if(!j.value||!j.value["id"])return void console.error("Проект не выбран");let e=await h.A.get(`/proekt/${j.value["id"]+1}/elements`);console.log(e),b.value=e.data.elements}catch(e){console.log(e)}},G=async e=>{try{let a=await h.A.get(`/element/${e}`);A.value=a.data.element}catch(a){console.log(a)}},H=async()=>{try{if(!A.value||!A.value["id"])return void console.error("Элемент не выбран");let e=await h.A.get(`/element/${A.value["id"]+1}/stages`);console.log(e),K.value=e.data.stages}catch(e){console.log(e)}},Z=async e=>{try{let a=await h.A.get(`/stage/${e}`);I.value=a.data.stage}catch(a){console.log(a)}},ee=async()=>{try{if(!I.value||!I.value["id"])return void console.error("Стадия не выбрана");let e=await h.A.get(`/blank/${I.value["id"]+1}/stages`);console.log(e),C.value=e.data.stages}catch(e){console.log(e)}},ae=(0,r.KR)([]),te=(0,r.KR)(!1),oe=async e=>{try{if(!e||e.trim().length<2)return void(ae.value=[]);const a=await B();if(!a)return;te.value=!0;const t=await h.A.get("/search",{params:{query:e.trim(),limit:20}});return ae.value=t.data.results,console.log("Search results:",t.data),t.data.results}catch(a){return console.error("Error in global search:",a),ae.value=[],N("Ошибка при выполнении поиска"),[]}finally{te.value=!1}},le=()=>{ae.value=[]},re=(0,r.KR)([]),ne=async e=>{try{const a=await B();if(!a)return;const t=await h.A.get(`/element-tehkarties/getByProject/${e}`);return re.value=t.data.techCards||[],console.log("Project tech cards loaded:",re.value.length),re.value}catch(a){return console.error("Error loading project tech cards:",a),re.value=[],[]}};return{isLoading:e,email:a,code:t,isAddProjectModalOpen:o,isAddTehkartaModalOpen:l,jwt:s,refreshToken:c,tokenExpiration:u,isAuthenticated:i,user:d,excelFile:v,tehkartaFile:g,userNotFound:p,errorMessage:m,successMessage:y,showError:k,showSuccess:w,proekts:R,proektSelected:j,proektId:S,elements:b,elementSelected:A,stages:K,blankStages:C,stageSelected:I,isReplacingTechCard:V,replacementType:J,isAdmin:E,logIn:F,verifyCode:T,sendCodeAgain:x,setTokens:U,isTokenValid:D,refreshAccessToken:$,logout:P,initializeAuth:L,checkAuthBeforeRequest:B,requireAuth:_,showErrorMessage:N,showSuccessMessage:M,hideMessages:O,excelUpload:z,tehkartaUpload:X,replaceProjectElements:Y,getProekts:q,getProekt:Q,getElements:W,getElement:G,getStages:H,getStage:Z,getStagesBlank:ee,searchResults:ae,isSearching:te,globalSearch:oe,clearSearchResults:le,projectTechCards:re,getProjectTechCards:ne}})),R={class:"wrap"},j={class:"code-inputs"},S=["onUpdate:modelValue","onInput","onKeydown"],b={class:"wrap-buttons"},A={key:0,class:"timer-section"},K={class:"timer"},I={class:"timer-digits"};var C={__name:"EmailVerify",setup(e){const a=w(),t=(0,r.KR)(["","","",""]),c=(0,r.KR)([]),u=(0,r.KR)(!1),i=(0,r.KR)(60),d=(0,r.KR)(null),v=(e,a)=>{const l=a.target.value.replace(/\D/g,"");t.value[e]=l,l&&e<t.value.length-1&&(0,o.dY)((()=>{c.value[e+1]?.focus()})),t.value.every((e=>""!==e))&&f()},p=(e,a)=>{"Backspace"===a.key&&!t.value[e]&&e>0&&c.value[e-1]?.focus()},h=e=>{e.preventDefault();const a=e.clipboardData.getData("text").replace(/\D/g,""),l=a.slice(0,4).split("");l.forEach(((e,a)=>{a<t.value.length&&(t.value[a]=e)}));const r=Math.min(l.length-1,t.value.length-1);(0,o.dY)((()=>{c.value[r]?.focus()})),f()},f=()=>{console.log("handleLogin called with code:",t.value.join("")),a.code=t.value.join(""),4===a.code.length&&a.verifyCode()},m=()=>{console.log("startCountdown called, current countdown:",i.value,"canResend:",u.value),!u.value&&i.value>0&&d.value?console.log("Timer already running, not restarting"):(d.value&&clearInterval(d.value),u.value=!1,i.value=60,d.value=setInterval((()=>{i.value-=1,i.value<=0&&(clearInterval(d.value),d.value=null,u.value=!0,console.log("Timer finished, can resend now"))}),1e3))},y=()=>{u.value&&(a.sendCodeAgain(),m())},k=(0,o.EW)((()=>{const e=i.value;return`00:${e.toString().padStart(2,"0")}`}));return(0,o.sV)((()=>{console.log("EmailVerify component mounted"),(0,o.dY)((()=>{c.value[0]?.focus()})),console.log("About to start countdown, current state:",i.value,u.value),m()})),(0,o.hi)((()=>{console.log("EmailVerify component unmounted, clearing timer"),d.value&&(clearInterval(d.value),d.value=null)})),(e,i)=>((0,o.uX)(),(0,o.CE)("div",R,[i[1]||(i[1]=(0,o.Lk)("div",{class:"wrap-image"},[(0,o.Lk)("img",{src:s,alt:"Email Icon"})],-1)),i[2]||(i[2]=(0,o.Lk)("h1",null,"Авторизация",-1)),(0,o.Lk)("p",null,"Мы отправили код для авторизации. На почту "+(0,l.v_)((0,r.R1)(a).email),1),(0,o.Lk)("div",j,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(t.value,((e,a)=>(0,o.bo)(((0,o.uX)(),(0,o.CE)("input",{key:a,"onUpdate:modelValue":e=>t.value[a]=e,onInput:e=>v(a,e),onKeydown:e=>p(a,e),onPaste:h,type:"text",inputmode:"numeric",pattern:"[0-9]*",maxlength:"1",class:"code-input",ref_for:!0,ref:e=>{e&&(c.value[a]=e)}},null,40,S)),[[n.Jo,t.value[a]]]))),128))]),(0,o.Lk)("div",b,[(0,o.bF)(g,{disabled:!u.value,onClick:y},null,8,["disabled"]),u.value?(0,o.Q3)("",!0):((0,o.uX)(),(0,o.CE)("div",A,[i[0]||(i[0]=(0,o.Lk)("p",{class:"timer-text"},"Отправить код повторно можно через:",-1)),(0,o.Lk)("div",K,[(0,o.Lk)("span",I,(0,l.v_)(k.value),1)])]))])]))}};const E=(0,i.A)(C,[["__scopeId","data-v-ad0af7c6"]]);var F=E}}]);
//# sourceMappingURL=882.23de91c9.js.map